<script>
  // ---------- helpers ----------
  function escapeHtml(s) {
    return String(s)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function getText(id) {
    var el = document.getElementById(id);
    return el ? el.value : "";
  }

  function setHtml(id, html) {
    var el = document.getElementById(id);
    if (el) el.innerHTML = html;
  }

  function copyText(text) {
    // Clipboard API is often blocked on managed/school browsers.
    // prompt() is ugly but works everywhere.
    window.prompt("Copy the code below:", text);
  }

  // ---------- templates (NO backticks, ES5 safe) ----------
  var templates = [
    {
      id: "km_logrank",
      name: "Kaplan–Meier + log-rank",
      keywords: [/kaplan/i, /log\s*rank/i, /survdiff/i, /survival curve/i],
      code: [
        "# Step 1",
        "",
        "library(survival)",
        "s1 <- survfit(Surv(TIME, OUTCOME) ~ GROUP, data=DATA)",
        "summary(s1)",
        "plot(s1)",
        "survdiff(Surv(TIME, OUTCOME) ~ GROUP, data=DATA)"
      ].join("\n")
    },
    {
      id: "glm_binomial",
      name: "Logistic regression (binomial) + OR via getCI()",
      keywords: [/logistic/i, /glm/i, /odds ratio/i, /binomial/i],
      code: [
        "# Step 1",
        "",
        "m1 <- glm(OUTCOME ~ EXPOSURES, data=DATA, family=\"binomial\")",
        "summary(m1)",
        "",
        "# Step 2",
        "",
        "source(\"getCI.R\")",
        "round(exp(getCI(m1)), 2)"
      ].join("\n")
    },
    {
      id: "wilcoxon",
      name: "Wilcoxon / Mann–Whitney test (2 groups)",
      keywords: [/wilcoxon/i, /mann/i, /compare/i, /distribution/i, /non[- ]?parametric/i],
      code: [
        "# Step 1",
        "",
        "wilcox.test(VARIABLE ~ GROUP, data=DATA)",
        "",
        "# Alternative syntax",
        "",
        "with(DATA, wilcox.test(VARIABLE[GROUP==0], VARIABLE[GROUP==1]))"
      ].join("\n")
    },
    {
      id: "sens_spec",
      name: "Sensitivity & specificity (diagnostic test)",
      keywords: [/sensitivity/i, /specificity/i, /rapid antigen/i, /\bRAT\b/i, /infectiv/i],
      code: [
        "# Step 1",
        "",
        "# Sensitivity: P(TEST=1 | DISEASE=1)",
        "with(DATA, sum(TEST==1 & DISEASE==1) / sum(DISEASE==1))",
        "",
        "# Specificity: P(TEST=0 | DISEASE=0)",
        "with(DATA, sum(TEST==0 & DISEASE==0) / sum(DISEASE==0))"
      ].join("\n")
    },
    {
      id: "hist_survival_compare",
      name: "Histogram of survival times + compare died vs survived (Wilcoxon)",
      keywords: [/histogram/i, /survival times/i, /compare/i, /distribution/i, /died/i, /survived/i, /follow-?up/i],
      code: [
        "# Step 1",
        "",
        "hist(DATA$TIME)",
        "",
        "# Step 2",
        "# Compare distributions by outcome",
        "with(DATA, summary(TIME[STATUS==0]))",
        "with(DATA, summary(TIME[STATUS==1]))",
        "",
        "# Step 3",
        "with(DATA, wilcox.test(TIME ~ STATUS))"
      ].join("\n")
    }
  ];

  // ---------- UI rendering ----------
  function renderTemplates(matches) {
    if (!matches.length) {
      setHtml("results",
        "<div class='card'><b>No match.</b> Add keywords/templates for that phrasing.</div>"
      );
      return;
    }

    var html = "";
    for (var i = 0; i < matches.length; i++) {
      var t = matches[i];
      html += "<div class='card'>";
      html += "<h3>" + escapeHtml(t.name) + "</h3>";
      html += "<button data-copy-id='" + escapeHtml(t.id) + "'>Copy</button>";
      html += "<pre id='code_" + escapeHtml(t.id) + "'>" + escapeHtml(t.code) + "</pre>";
      html += "</div>";
    }
    setHtml("results", html);

    // Attach copy handlers (works in older browsers)
    var buttons = document.querySelectorAll("button[data-copy-id]");
    for (var j = 0; j < buttons.length; j++) {
      buttons[j].onclick = function () {
        var id = this.getAttribute("data-copy-id");
        var pre = document.getElementById("code_" + id);
        copyText(pre ? pre.innerText : "");
      };
    }
  }

  function matchTask() {
    var text = getText("task");
    var matches = [];
    for (var i = 0; i < templates.length; i++) {
      var t = templates[i];
      var ok = false;
      for (var k = 0; k < t.keywords.length; k++) {
        if (t.keywords[k].test(text)) { ok = true; break; }
      }
      if (ok) matches.push(t);
    }
    renderTemplates(matches);
  }

  // Make sure the inline onclick can see it
  window.matchTask = matchTask;

  // Optional: show it's alive
  // If your friend sees this, JS loaded successfully.
  // alert("Templates script loaded");
</script>
